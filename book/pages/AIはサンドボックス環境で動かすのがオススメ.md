# AIはサンドボックス環境で動かすのがオススメ

**AIはサンドボックス環境で動かすことを強くお勧めします。その理由は2つあります：**

1. **セキュリティリスクの回避**：情報漏洩やコード破壊といったリスクを完全に防げる
2. **生産性の爆発的向上**：AIの完全自律実行モードを安全に使える

## サンドボックス環境とは

**サンドボックス環境＝本番環境から完全に隔離された環境**

ローカル開発環境として作成するDocker環境は、サンドボックス環境の代表格です。

具体的には：
- 壊れても問題のない環境（Dockerコンテナ等）
- 本番DB、本番サーバーへの通信が遮断されている
- いつでも作り直せる使い捨て環境

**加えて、重要な運用ルール：**
- サンドボックス環境に持ち込むデータは、**必ず機密情報をマスキング**する
  - 例：メールアドレスを `test@example.com` に置換
  - 例：決済情報テーブルを除外
  - 例：APIキーをダミー値に置換

**それでは、サンドボックス環境の2つのメリットについて見ていきましょう。**

## メリット1：セキュリティリスクの回避

AI駆動開発には、大きく分けて2つのセキュリティリスクがあります：

1. **情報漏洩**：AIプロバイダーへの機密情報・個人情報の送信
2. **コード/データ破壊**：AIが生成した破壊的なコードの実行（`rm -rf /`、`DROP DATABASE`等）

サンドボックス環境を使えば、これらのリスクを完全に回避できます。

### リスク1：情報漏洩を防ぐ

**問題**：本番環境の個人情報・機密情報がAIプロバイダーに送信されてしまう

**解決策**：

AIの手が届くところに、機密情報を置くのは運用で禁止します。
つまり、AIは通信が隔離されたサンドボックス上でのみ動かし、そこには機密情報を置かないルールにします。

本番環境のデータを使いたい場合は、機密情報をマスキングした上でサンドボックス環境に持ち込みます。マスキング済みのデータであれば、AIプロバイダー（OpenAI等）に送信されても安全です。

具体的には：
- メールアドレスを `test@example.com` に置換
- 決済情報テーブルを除外
- APIキーをダミー値に置換

### リスク2：コード/データ破壊を防ぐ

**問題**：AIが生成した破壊的なコードが本番環境で実行されてしまう

例えば、AIが以下のような破壊的なコードを生成する可能性があります：
- `rm -rf /` でシステム全体が削除される
- `DROP DATABASE production;` で本番DBが削除される

**解決策**：

サンドボックス環境でAIを実行すれば、これらのリスクは100%回避できます。

そのためにも、サンドボックス環境は本番環境に通信できないよう隔離します。
もちろんSSH接続も出来ないようにします。

## サンドボックス環境のメリット2：生産性の爆発的向上

通常、AIは危険なコマンドを実行する際、人間に確認を求めます：

```
AI: 「rm -rf /tmp/old_files を実行してもよろしいですか？」
```

この確認作業は安全ですが、毎回確認を求められるため自律性が低く、**生産性が低い**です。

それを解消するのが「完全自立実行モード」です

### 完全自律実行モードとは

Claude Codeのような自律性の高いAIには、**完全自律実行モード**があります：

```bash
# 人間の許可を求めずに完全自律実行
claude --dangerously-skip-permissions
```

このモードでは：
- AIが人間に確認を求めない
- あなたが寝ている間もAIがタスクを進める
- 人間が張り付いて監視することから解放されるので、別の仕事に集中できる
- **生産性が桁違いに向上する**

### 完全自律実行モードのリスク

ただし、このモードは**非常に危険**です。
例え個人開発だとしても、 

```
rm -rf /
```

コマンドであなたのパソコンを壊してしまうかもしれません。
リスク管理は、**AIが暴走して何をやらかすかわからない**という前提で考えるべきです。

### サンドボックス環境なら安全に使える

サンドボックス環境であれば、AIが暴走してもノーリスクです。だからこそ、完全自律実行モードを安全に使えるようになります。

**これが、サンドボックス環境でAIを動かすことを強く強くお勧めする理由です。**


## 本番バグ調査時のセキュリティ原則

本番環境のデータをAIで調査する際は、以下の原則を必ず守ってください。

### 原則1：本番環境で直接AIツールを使わない

- 本番環境でCursor、Claude Code等のAIツールを直接使用しない
- 本番サーバーにAIツールをインストールしない
- 必ず隔離された環境にコピーしてから使う

**理由**：
AIが本番DBを勝手に更新する、本番サーバーで破壊的なコマンドを実行するなど、予期しない動作をするリスクがあります。

### 原則2：ローカル環境でもサンドボックス環境を使う

ローカル環境にAIツールがインストールされていて、かつその環境から本番にSSH接続ができてしまう場合、**AIが本番環境にアクセスできてしまうため、これも絶対にNGです。**

**悪い例**：
```
ローカルPC（AIツールあり）
  ├─ ~/.ssh/config に本番サーバーへの接続設定
  ↓ SSH接続可能
本番サーバー
  ↓ AIが本番にアクセスできてしまう（NG）
```

**良い例**：
```
ローカルPC
  ↓
Dockerサンドボックス環境（AIツールあり）
  - 本番へのSSH設定なし
  - 本番へのネットワーク接続を遮断
  - サンドボックスDBのみ接続可
  ↓ AIは隔離環境のみアクセス（OK）
```

**正しい方法**：
1. ローカル環境上に**サンドボックス環境（Docker）を立てる**
2. サンドボックス環境の中でAIツールを使う
3. サンドボックス環境からは本番に接続できないようにする（SSH設定を分離）
4. `docker-compose.yml`の`networks: internal: true`で外部通信を遮断

### 原則3：機密情報を除外・マスキングする

**除外すべきデータ**：
- 個人情報（氏名、メールアドレス、電話番号、住所）
- 決済情報、クレジットカード情報
- 認証情報（パスワード、トークン、APIキー）

**マスキング方法**：

#### 方法1：ダミーデータに置換
```bash
# SQLダンプのメールアドレスを置換
sed -E 's/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/test@example.com/g' dump.sql > masked_dump.sql
```

#### 方法2：機密テーブルを除外
```bash
# 決済情報テーブルを除外してダンプ
mysqldump --ignore-table=database.payments --ignore-table=database.credit_cards database > dump.sql
```

#### 方法3：ログのマスキング
```bash
# ログからトークンをマスキング
sed -E 's/Bearer [A-Za-z0-9_-]+/Bearer ***/g' production.log > masked.log
```

### 原則4：本番への通信を遮断する

サンドボックス環境から本番環境への通信を完全に遮断します。

**docker-compose.ymlの設定**：
```yaml
networks:
  sandbox-network:
    driver: bridge
    internal: true  # インターネットアクセスを完全に遮断
```

**確認方法**：
```bash
# サンドボックス内から本番にアクセスできないことを確認
docker-compose exec sandbox bash
ping production-server.com  # 失敗するはず
ssh production-server  # 失敗するはず
```

### 原則5：必ず上司・セキュリティ担当に相談する

- 本番データの取り扱いは個人判断で行わない
- データのコピーや調査方法について、必ず上司の許可を取る
- 組織のセキュリティポリシーに従う
- 不明な点があれば、セキュリティ担当者に相談

## 本番バグ調査の実践例

### シナリオ：ECサイトの決済エラーを調査

#### Step 1: 本番データを取得（運用チームが実施）

```bash
# 本番DBダンプを取得
mysqldump -h production-db -u user -p database > production_dump.sql

# 本番ログをダウンロード
scp production-server:/var/log/app/* ./logs/
```

#### Step 2: 機密情報をマスキング

```bash
# メールアドレスを置換
sed -E 's/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/test@example.com/g' production_dump.sql > masked_dump.sql

# 決済情報テーブルを除外済みか確認
grep -i "INSERT INTO payments" masked_dump.sql  # 何も出力されなければOK
```

#### Step 3: サンドボックス環境に復元

```bash
# サンドボックスを起動
docker-compose up -d

# ダンプを復元
docker-compose exec -T sandbox-db mysql -u root -psandbox-password sandbox < masked_dump.sql

# ログをコピー
cp logs/* workspace/logs/
```

#### Step 4: AIで調査

```bash
# サンドボックスに入る
docker-compose exec sandbox bash

# 本番に接続できないことを確認
ping production-server.com  # 失敗
ssh production-server  # 失敗

# AIツールで調査開始
cursor .  # または claude-code
```

プロンプト例：
```
「決済エラーを調査してください。

【環境】
- DB：mysql -h sandbox-db -u root -psandbox-password sandbox
- ログ：/workspace/logs/application.log

【調査手順】
1. ログから該当時間帯のエラーを検索
2. transactionsテーブルで該当レコードを確認
3. 原因を特定

必ず証拠を提示してください。」
```

#### Step 5: 調査完了後の環境削除

```bash
# サンドボックス環境を削除
docker-compose down -v

# データも完全削除
rm -rf workspace/logs masked_dump.sql
```

## AIコード生成時の使い方

### Claude Codeでサンドボックスを使用

```bash
# サンドボックス内でClaude Codeを実行
docker-compose exec sandbox bash -c "claude-code"
```

### Cursorでサンドボックスを使用

Cursorの設定：

```json
// .vscode/settings.json
{
  "terminal.integrated.defaultProfile.linux": "docker",
  "terminal.integrated.profiles.linux": {
    "docker": {
      "path": "docker",
      "args": ["exec", "-it", "ai-sandbox", "bash"]
    }
  }
}
```

これで、Cursorのターミナルが自動的にサンドボックス内で開きます。

## サンドボックスのリセット

コンテナが破壊された場合、簡単にリセットできます：

```bash
# コンテナを削除
docker-compose down

# 再作成
docker-compose up -d

# 完全にクリーンな状態に戻る
```

## まとめ

### サンドボックス環境の定義（再確認）

サンドボックス環境とは：

1. **隔離された環境**（本番から分離）
2. **本番への通信遮断**（本番DB・サーバーにアクセス不可）
3. **機密情報のマスキング**（個人情報・機密情報を除外/置換）

**この3つを満たすことで、リスク1（情報漏洩）とリスク2（コード/データ破壊）に対応できます。**

### 2つのリスクへの対応

| リスク | サンドボックスでの対応 | 具体的な方法 |
|-------|-----------------|------------|
| **リスク1：情報漏洩** | ✅ 対応可能 | 機密情報をマスキングしてから持ち込む（サンドボックスの定義の一部） |
| **リスク2：コード/データ破壊** | ✅ 対応可能 | 隔離環境で実行し、本番との通信を遮断 |

### セキュリティ原則まとめ

1. **本番環境で直接AIツールを使わない**（リスク2対応）
2. **ローカル環境でもサンドボックス環境を使う**（リスク2対応）
3. **機密情報を除外・マスキングする**（リスク1対応）← サンドボックスの必須要件
4. **本番への通信を遮断する**（リスク2対応）← サンドボックスの必須要件
5. **必ず上司・セキュリティ担当に相談する**（全リスク対応）

### サンドボックス環境の利点

1. **機密情報漏洩を防ぐ**（リスク1対応）← マスキングを徹底
2. **AIの破壊的なコードから本番環境を保護**（リスク2対応）
3. **本番データを安全に調査できる**（リスク2対応）
4. **完全自律実行モードが使える**（生産性が爆発的に向上）
5. 簡単にリセット可能
6. リソース制限でシステムダウンを防止
7. 権限を最小化してセキュリティ向上

**サンドボックス環境を正しく構築・運用することで、AI駆動開発の主要なセキュリティリスク（情報漏洩・コード破壊）に対応できます。特に、機密情報のマスキングはサンドボックス環境の必須要件です。**
