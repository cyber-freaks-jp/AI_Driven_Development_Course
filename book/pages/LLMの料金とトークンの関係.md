# LLMの料金とトークンの関係

## はじめに

LLMの利用料金は、主にトークン数に基づいて計算されます。この章では、料金体系とコスト最適化について説明します。

## 料金体系の基本

### 1. トークンベースの課金

LLMサービスの多くは、使用したトークン数に応じて料金が発生します。

- 入力トークン（プロンプト）
- 出力トークン（生成されたテキスト）
- 合計トークン数

### 2. 料金の構成

```
総コスト = (入力トークン数 × 入力単価) + (出力トークン数 × 出力単価)
```

### 3. モデルによる違い

- 高性能モデル：高価格
- 標準モデル：中価格
- 軽量モデル：低価格

## 主要サービスの料金例（2025年時点）

### OpenAI GPT-4 Turbo

- 入力：$0.01 / 1K トークン
- 出力：$0.03 / 1K トークン

例：1万トークンの処理
- 入力5千トークン：$0.05
- 出力5千トークン：$0.15
- 合計：$0.20

### Anthropic Claude 3

- Opus：$15 / 1M 入力、$75 / 1M 出力
- Sonnet：$3 / 1M 入力、$15 / 1M 出力
- Haiku：$0.25 / 1M 入力、$1.25 / 1M 出力

### Google Gemini Pro

- 入力：$0.0005 / 1K トークン
- 出力：$0.0015 / 1K トークン

## コスト最適化の戦略

### 1. モデルの使い分け

```
シンプルなタスク → 軽量モデル（低コスト）
複雑なタスク → 高性能モデル（高コスト）
```

適切な選択例：
- データ分類：GPT-3.5 Turbo / Claude Haiku
- コード生成：GPT-4 / Claude Sonnet
- 複雑な推論：GPT-4 Turbo / Claude Opus

### 2. プロンプトの最適化

効率的なプロンプト：
- 簡潔な指示
- 明確な構造
- 不要な情報の除去

悪い例（500トークン）：
```
私は現在、Webアプリケーションを開発しており、
その中でユーザー認証機能を実装したいと考えています。
具体的には...（長い説明が続く）
```

良い例（100トークン）：
```
Web アプリの JWT 認証実装例を Python/Flask で教えて。
要件：
- ログイン/ログアウト
- トークン検証
- リフレッシュトークン
```

### 3. レスポンス長の制限

```python
# max_tokens パラメータで出力を制限
response = openai.ChatCompletion.create(
    model="gpt-4",
    messages=[{"role": "user", "content": "説明して"}],
    max_tokens=500  # 出力を500トークンに制限
)
```

### 4. キャッシュの活用

- 同じクエリの結果を保存
- 繰り返しの API 呼び出しを削減
- システム側でのキャッシング

### 5. バッチ処理

- 複数のリクエストをまとめる
- API 呼び出し回数の削減
- オーバーヘッドの最小化

## コスト管理のベストプラクティス

### 1. モニタリング

- 使用量の追跡
- コストの可視化
- 予算設定とアラート

### 2. 開発時の注意点

```python
# 開発環境では軽量モデルを使用
if ENV == "development":
    model = "gpt-3.5-turbo"  # 低コスト
else:
    model = "gpt-4"  # 本番のみ高性能モデル
```

### 3. ユーザー側の制限

- リクエスト数の制限（レートリミット）
- 入力文字数の上限設定
- 出力長の適切な制御

## 実際のコスト例

### ケース1：チャットボット

月間利用：
- ユーザー数：1,000人
- 平均会話：10往復/人
- 平均トークン：500トークン/往復

計算：
```
総トークン = 1,000 × 10 × 500 = 5,000,000トークン
月額コスト（GPT-3.5）≈ $10
月額コスト（GPT-4）≈ $100
```

### ケース2：コード生成ツール

月間利用：
- リクエスト数：10,000
- 平均入力：200トークン
- 平均出力：800トークン

計算：
```
入力トークン = 10,000 × 200 = 2,000,000
出力トークン = 10,000 × 800 = 8,000,000
月額コスト（GPT-4）≈ $260
```

## まとめ

LLM の料金はトークン数に直接連動します。適切なモデル選択、プロンプトの最適化、キャッシュの活用などにより、コストを大幅に削減できます。開発時からコストを意識した設計を行うことが重要です。
