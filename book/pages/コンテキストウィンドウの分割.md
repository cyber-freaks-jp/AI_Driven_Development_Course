# コンテキストウィンドウの分割

## はじめに

AIツールを使っていると、つい1つの会話で色々な指示を出してしまいがちです。しかし、**コンテキストウィンドウを適切に分割する**ことで、AIの応答品質を大幅に向上させることができます。

## コンテキストウィンドウとは（復習）

### 基本概念

**コンテキストウィンドウ：**
- AIが一度に参照できる情報の範囲
- 会話の履歴全体が含まれる
- トークン数に上限がある

**イメージ：**
```
┌─────────────────────────────────┐
│  コンテキストウィンドウ          │
│                                 │
│  [過去の会話1]                   │
│  [過去の会話2]                   │
│  [過去の会話3]                   │
│  ...                            │
│  [現在の指示] ← AIはこれを見る   │
│                                 │
└─────────────────────────────────┘
```

### 問題：コンテキストの混在

**悪い例：**
```
あなた: React でToDoアプリを作って
AI: [ToDoアプリのコード生成]

あなた: デザインを改善して
AI: [デザイン改善]

あなた: あ、次はPythonでAPIサーバー作って
AI: [混乱した応答]
  ※ ToDoアプリのコンテキストが残っている
```

**何が問題か：**
- AIは「ToDoアプリの話の続き？」と混乱
- Reactのコードとの関連を探そうとする
- 品質が下がる

## コンテキスト分割の原則

### 原則1：1コンテキスト = 1タスク

**推奨：**
```
コンテキスト1: ToDoアプリの開発
  → ToDoアプリに関する指示のみ

コンテキスト2: APIサーバーの開発
  → APIサーバーに関する指示のみ
```

### 原則2：関連する指示は同じコンテキスト

**OK：同じコンテキスト**
```
あなた: ToDoアプリを作って
AI: [コード生成]

あなた: 削除機能を追加して
AI: [機能追加]

あなた: テストコードも追加して
AI: [テスト追加]

※ 全てToDoアプリに関連しているのでOK
```

**NG：コンテキストを分けるべき**
```
あなた: ToDoアプリを作って
AI: [コード生成]

あなた: データベース設計について教えて
AI: [一般的な説明... ToDoアプリと混同される可能性]

※ 一般的な質問は別コンテキストで
```

### 原則3：コンテキストが長くなったら分割

**目安：**
- 会話のやり取りが10回以上
- 複数の機能を実装した
- トピックが変わった

## 各ツールでのコンテキスト分割方法

### Cursor の場合

#### 新しいチャットを開く

**方法1：Cmd + L で新規チャット**
```
1. Cmd + L を押す
2. 新しいチャットパネルが開く
3. 前のコンテキストは保持される（別タブ）
```

**方法2：チャット履歴から新規作成**
```
1. チャットパネル上部の「New Chat」をクリック
2. 新しいコンテキストで開始
```

#### いつ新しいチャットを作るか

✓ **新規作成するべき場合：**
- 全く別のプロジェクトに切り替える
- 異なる言語・フレームワークで開発
- 一般的な質問をする
- 設計の相談をする

✗ **継続するべき場合：**
- 同じファイルの修正を続ける
- 実装中の機能を追加・改善
- エラー修正
- テスト追加

### Claude Code の場合

#### /clear コマンド

Claude Code では `/clear` コマンドでコンテキストをクリア：

```bash
# Claude Code 実行中
claude> /clear

# コンテキストがクリアされる
# 新しいタスクを開始できる
```

#### /clear を使うタイミング

**使うべき場合：**
```
# ケース1：タスク完了後
claude> ToDoアプリを作成
[完成]
claude> /clear
claude> 次はAPIサーバーを作成  # クリーンな状態で開始
```

```
# ケース2：方向転換
claude> Reactで実装して
[何か違う...]
claude> /clear
claude> やっぱりVueで実装して  # 前のReactの話は忘れる
```

```
# ケース3：エラーが続く
claude> バグを修正して
[修正試行1: 失敗]
[修正試行2: 失敗]
[修正試行3: 失敗]
claude> /clear
claude> 最初からバグ修正を試みて  # リセットして再挑戦
```

**使わなくて良い場合：**
```
# ケース1：連続した作業
claude> ユーザー管理機能を実装
claude> 次に認証機能を追加
claude> エラーハンドリングも追加
# → 関連しているので /clear 不要
```

#### Claude Code を再起動

完全にリセットしたい場合：

```bash
# Ctrl + C で終了
^C

# 再起動
claude-code
```

### ChatGPT / Claude (Web版) の場合

#### 新しいチャットを開始

**方法：**
1. サイドバーの「New Chat」をクリック
2. または画面左上の「+」ボタン

**いつ使うか：**
- 別のプロジェクトについて質問
- 異なる技術スタックの話題
- 一般的な知識の質問

## 実践例

### 例1：機能追加プロジェクト

**コンテキスト1：ユーザー管理機能**
```
あなた: ユーザー管理機能を実装して
AI: [実装]

あなた: バリデーションを追加
AI: [追加]

あなた: テストも作成
AI: [テスト作成]

完了！
```

**コンテキスト2：商品管理機能（新規）**
```
[新しいチャット / /clear]

あなた: 商品管理機能を実装して
AI: [クリーンな状態で実装開始]
```

### 例2：エラー修正と新機能

**コンテキスト1：エラー修正**
```
あなた: ログイン時のエラーを修正して
AI: [修正試行]

あなた: まだエラーが出る
AI: [再修正]

あなた: 動いた！
完了！
```

**コンテキスト2：新機能（新規）**
```
[新しいチャット / /clear]

あなた: パスワードリセット機能を追加
AI: [クリーンな状態で実装]
```

### 例3：設計相談と実装

**コンテキスト1：設計相談**
```
あなた: マイクロサービスのアーキテクチャについて相談
AI: [アドバイス]

あなた: データベース設計は？
AI: [設計提案]

完了！
```

**コンテキスト2：実装（新規）**
```
[新しいチャット / /clear]

あなた: では、ユーザーサービスを実装して
AI: [実装開始]
```

## コンテキスト分割の判断フロー

```
新しい指示を出す前に確認：

┌─────────────────────────┐
│ 今の作業と関連してる？    │
└─────────────────────────┘
         ↓
    Yes  │  No
         ↓
    ┌────┴────┐
    │         │
┌───↓──┐  ┌───↓──┐
│継続OK│  │分割! │
└──────┘  └──────┘
            │
            ↓
    新しいコンテキストで開始
```

### チェックリスト

以下に該当したら**新しいコンテキスト**を作成：

- [ ] 別のプロジェクト・ファイルの話
- [ ] 異なる言語・フレームワーク
- [ ] 前の作業が完了した
- [ ] 方向転換したい
- [ ] エラーが続いて行き詰まった
- [ ] 一般的な質問・相談をしたい
- [ ] コンテキストが長くなりすぎた（10往���以上）

## コンテキスト分割のメリット

### 1. AIの応答品質が向上

**理由：**
- 関連する情報だけに集中できる
- 混乱が減る
- より正確な提案

**例：**
```
❌ 混在したコンテキスト
「Reactのコードを書いて」
「Pythonでスクリプトを...」
→ AIが混乱

✅ 分割されたコンテキスト
コンテキスト1: React開発
コンテキスト2: Pythonスクリプト
→ それぞれクリーンな状態
```

### 2. トークン数の節約

**長いコンテキスト：**
```
[会話1: 1000トークン]
[会話2: 1000トークン]
[会話3: 1000トークン]
[現在の指示]
→ 毎回3000トークン消費
```

**分割されたコンテキスト：**
```
コンテキスト1: [会話1: 1000トークン]
コンテキスト2: [会話2: 1000トークン]
コンテキスト3: [会話3: 1000トークン]
→ 各1000トークンのみ消費
```

### 3. 管理しやすい

**メリット：**
- どのコンテキストで何をしたか明確
- 後で振り返りやすい
- チームで共有しやすい

**例（Cursor）：**
```
チャット1: 「ユーザー管理機能」
チャット2: 「商品管理機能」
チャット3: 「決済機能」
→ 一目で内容がわかる
```

### 4. エラーからの回復が早い

**行き詰まったとき：**
```
古いコンテキスト: [複雑な履歴]
  ↓ /clear
新しいコンテキスト: [クリーンな状態]
  → 新しい視点で問題に取り組める
```

## よくある質問

### Q1: 頻繁にコンテキストを切り替えすぎ？

**A:** タスクごとに切り替えるのが基本。目安：

- 小さなタスク（バグ修正など）→ 1コンテキスト
- 中規模機能（CRUD実装など）→ 1-2コンテキスト
- 大規模機能（認証システムなど）→ 3-5コンテキスト

### Q2: 前のコンテキストの情報を引き継ぎたい

**A:** 必要な情報を明示的に伝える：

```
[新しいコンテキスト]

あなた: 先ほど作成したユーザー管理機能と連携する
商品管理機能を実装してください。

ユーザーテーブル:
- id: number
- name: string
- email: string

商品は各ユーザーに紐づきます。
```

### Q3: /clear と 新しいチャットの違いは？

**Claude Code:**
- `/clear` → 同じセッション内でコンテキストクリア
- 再起動 → 完全に新しいセッション

**Cursor:**
- 同じチャット内で継続 → コンテキスト保持
- 新しいチャット → 新しいコンテキスト

### Q4: 関連するけど別のファイルの場合は？

**A:** 同じコンテキストでOK、ただし明確に指示：

```
あなた: @user.ts と連携する @auth.ts を作成してください。

user.ts の User型を使用します。
```

## ベストプラクティス

### 1. タスク開始時にコンテキストを確認

```
新しいタスクを始める前に：
「これは今のコンテキストの続き？」
→ Yes: そのまま続ける
→ No: 新しいコンテキストを作成
```

### 2. コンテキストに名前をつける（心の中で）

```
今は「ユーザー管理機能の実装」コンテキスト
→ ユーザー関連の指示のみ

次は「商品管理機能の実装」コンテキスト
→ 商品関連の指示のみ
```

### 3. 行き詰まったら /clear

```
何度試してもうまくいかない...
↓
/clear で新しい視点から
```

### 4. 一般的な質問は別コンテキスト

```
実装中に「TypeScriptの型って何？」
→ 実装コンテキストで聞くと混乱
→ 新しいコンテキストで質問
```

## まとめ

**コンテキスト分割のポイント：**

✓ **1コンテキスト = 1タスク**
  - 明確な境界を作る
  - 混ぜない

✓ **関連する作業は同じコンテキスト**
  - 連続した実装
  - バグ修正
  - 機能追加

✓ **行き詰まったらリセット**
  - /clear でクリア
  - 新しいチャットで再挑戦

✓ **適切なタイミングで分割**
  - タスク完了後
  - 方向転換時
  - コンテキストが長くなったら

**効果：**
- AIの応答品質が向上
- トークン数を節約
- 管理しやすい
- 効率的な開発

コンテキストウィンドウを適切に管理することで、AI駆動開発の効率が大幅に向上します！
