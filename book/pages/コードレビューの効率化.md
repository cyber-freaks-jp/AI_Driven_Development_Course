# コードレビューの効率化

**AIを活用することで、コードレビューの効率と品質を大幅に向上させることができます。**

## ECサイトの決済機能をレビューしてみよう

実装したECサイトの決済機能を、AIにレビューさせます。

通常、Gitでは機能ごとにブランチを切って開発します。レビュー時は、**そのブランチ全体をまとめてAIにレビューさせる**ことができます

### ブランチ単位での包括的レビュー

決済機能を実装した `feature/payment` ブランチ全体を、要件定義書と設計書を参照しながらレビューさせる例を紹介します

なお、このような使い方をするために、**AIが動作する環境に**gitをインストールしておきましょう。また、APIやMCPで接続できるようにしておくと、AIがgithubにコメントを残すなどの操作が可能になります

```
プロンプト：
「決済機能を実装したので、コードレビューしてください。

以下を参照してレビューしてください：
- @docs/要件定義書.md
- @docs/設計書.md
- このブランチの全変更（git diff main...HEAD）

以下の順番でチェックしてください：
Step1. コード品質（可読性、保守性、命名規則）
Step2. エラーハンドリング
Step3. セキュリティ（OWASP Top 10）
Step4. パフォーマンス
Step5. 設計書との整合性
Step6. 要件定義書との整合性

問題があれば、重要度別（重大・警告・推奨）に分けてレポートしてください。

レポート結果はgithubのPR(#34)にコメントを残してください。
」
```


### AIに修正を実装させる

レビュー結果を受けて、そのままAIに修正を依頼できます。

```
プロンプト：
「先ほど指摘した【重大】と【警告】の問題をすべて修正してください。」
```

AIが自動で修正してくれます。

### GitHub上で自動レビューを実行する

プルリクエストが作成されるたびに、自動でAIレビューが実行されるように設定できます。

GitHub Actions を使うことで、**レビュー依頼を忘れることなく、すべてのPRで自動的にAIレビューが実行されます。**

```yaml
# .github/workflows/ai-review.yml
name: AI Code Review

on:
  pull_request:
    branches: [main]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 全履歴を取得

      - name: AI Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Claude APIを使ってレビュー実行
          curl https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "content-type: application/json" \
            -d '{
              "model": "claude-3-5-sonnet-20241022",
              "max_tokens": 4096,
              "messages": [{
                "role": "user",
                "content": "このPRのコードをレビューしてください。\n\n$(git diff origin/main...HEAD)"
              }]
            }' > review.json

      - name: Post Review as Comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const review = JSON.parse(fs.readFileSync('review.json', 'utf8'));
            const body = review.content[0].text;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## 🤖 AI Code Review\n\n${body}`
            });
```

#### セットアップ手順

1. **Claude APIキーを取得**
   - https://console.anthropic.com でAPIキーを作成

2. **GitHubにシークレットを追加**
   - リポジトリの Settings → Secrets and variables → Actions
   - `ANTHROPIC_API_KEY` を追加

3. **ワークフローファイルを作成**
   - `.github/workflows/ai-review.yml` を作成
   - 上記のYAMLを配置

4. **プルリクエストを作成**
   - 自動的にAIレビューが実行され、コメントが投稿されます

#### 自動レビューのメリット

- **レビュー漏れ防止**：すべてのPRで自動実行
- **即時フィードバック**：PR作成直後にレビュー結果を取得
- **レビュー負荷軽減**：人間は最終チェックに集中できる
- **一貫性**：同じ基準でレビューが実行される

## セキュリティレビューに特化

セキュリティに特化したレビューも可能です。

```
プロンプト：
「@backend/src/routes/payment.ts をセキュリティレビューしてください。

OWASP Top 10 の観点で以下をチェックしてください：
- SQLインジェクション
- XSS
- CSRF
- 認証・認可の不備
- 機密情報の漏洩
- 暗号化の不備

脆弱性があれば、具体的な修正案を提示してください。」
```

AIの指摘例：

```
## セキュリティレビュー結果

### 【重大】認証の不備

**問題箇所**：
決済APIに認証ミドルウェアが適用されていません。

**リスク**：
誰でも決済Intentを作成できてしまいます。

**改善案**：
\`\`\`typescript
router.post('/create-intent', authMiddleware, async (req, res) => {
  // ...
});
\`\`\`

---

### 【警告】ログへの機密情報出力

**問題箇所**：
\`\`\`typescript
console.log('Payment Intent:', paymentIntent);
\`\`\`

**リスク**：
決済情報がログに出力され、機密情報漏洩のリスクがあります。

**改善案**：
必要最小限の情報のみログ出力する、またはログを削除する。
```

## パフォーマンスレビュー

パフォーマンスの問題もAIでチェックできます。

```
プロンプト：
「@backend/src/routes/payment.ts をパフォーマンスレビューしてください。

以下の観点でチェックしてください：
- 不要な同期処理
- 非効率なデータ構造
- キャッシュの活用不足
- タイムアウト設定の不備

問題があれば、具体的な改善案を提示してください。」
```

## 人間による最終レビュー

AIのレビュー結果を参考に、**人間が最終的にレビューします。**

### AIと人間の得意分野

| AIが得意 | 人間が得意 |
|---------|-----------|
| 構文エラー | ビジネスロジックの妥当性 |
| セキュリティの基本 | UX/UIの妥当性 |
| パフォーマンスの基本 | エッジケースの想定 |
| コーディング規約 | 長期的な保守性 |
| 設計書との整合性チェック | 要件の背景・意図の理解 |

### レビューチェックリスト

人間のレビュー漏れを防ぐため、チェックリストを用意します。

```markdown
## コードレビューチェックリスト

### 機能性
- [ ] 要件定義書の仕様を満たしているか
- [ ] 設計書と整合性が取れているか
- [ ] エッジケースに対応しているか

### コード品質
- [ ] 可読性は高いか
- [ ] 命名規則は統一されているか
- [ ] 不要なコードはないか

### セキュリティ
- [ ] AIの指摘事項は修正されているか
- [ ] 入力値はバリデーションされているか
- [ ] 認証・認可は適切か
- [ ] 機密情報（APIキー等）が適切に管理されているか

### パフォーマンス
- [ ] AIの指摘事項は修正されているか
- [ ] N+1クエリはないか
- [ ] キャッシュは適切に使われているか

### テスト
- [ ] ユニットテストは十分か
- [ ] テストは実際に通るか
- [ ] エッジケースのテストもあるか

### ビジネスロジック
- [ ] 実際のビジネス要件を満たしているか
- [ ] 将来の拡張性は考慮されているか
- [ ] 他の機能との整合性は取れているか
```

## GitHubでのAIレビュー自動化

GitHub Actions でAIレビューを自動化できます。

プルリクエストが作成されるたびに、AIが自動でコードレビューを行います。

```yaml
# .github/workflows/code-review.yml
name: AI Code Review

on:
  pull_request:
    branches: [main]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: AI Code Review
        run: |
          # AIにレビューさせるスクリプトを実行
          claude-code "このPRのコードをレビューして、問題があれば指摘してください"

      - name: Post Review Comments
        uses: actions/github-script@v6
        with:
          script: |
            // AIレビュー結果をPRにコメント
```

## まとめ

コードレビューの効率化のポイント：

### AIに任せる部分

1. **基本的なレビュー**
   - 構文エラー、コーディング規約
   - セキュリティの基本チェック
   - パフォーマンスの基本チェック

2. **整合性チェック**
   - 設計書との整合性
   - 要件定義書との整合性
   - @記法で正確に参照

3. **自動修正**
   - AIが指摘した問題をAIに修正させる
   - 人間は結果を確認するだけ

### 人間が最終判断する部分

1. **ビジネスロジックの妥当性**
   - 実際のビジネス要件を満たしているか
   - エッジケースに対応しているか

2. **UX/UIの妥当性**
   - ユーザー体験は良いか
   - エラーメッセージは分かりやすいか

3. **長期的な保守性**
   - 将来の拡張性は考慮されているか
   - 技術的負債になっていないか

**AIで自動化できる部分はAIに任せ、人間は本質的な判断に集中する。これがAI駆動開発のコードレビューです。**

次の章では、AIでテストコードを自動生成する方法を学びます。
