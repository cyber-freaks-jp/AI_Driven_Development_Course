# サンドボックス環境の構築

AIが生成したコードを安全に実行するためには、サンドボックス環境（隔離環境）が不可欠です。このセクションでは、Dockerを使ったサンドボックス環境の構築方法を解説します。

## サンドボックス環境とは

**サンドボックス＝砂場**

子供が砂場で遊んでも、砂が外に広がらないように、隔離された環境でコードを実行し、本番環境に影響を与えないようにします。

### なぜサンドボックスが必要なのか

AIが生成したコードには、以下のリスクがあります：

```bash
# AIが生成した破壊的なコード例
rm -rf /  # システム全体が削除される
DROP DATABASE production;  # 本番DBが削除される
while true; do fork; done  # システムダウン
```

サンドボックス環境で実行すれば、これらのコードが実行されても本番環境には影響しません。

## Dockerによるサンドボックス環境

### Dockerとは

- コンテナ型の仮想化技術
- ホストOSから隔離された環境
- 軽量で高速
- 簡単に作成・削除可能

### 基本的なサンドボックス構成

```
ホストOS（本番環境）
    ↓ 完全に隔離
Dockerコンテナ（サンドボックス）
    ↓ この中でAIコードを実行
    → 破壊されても本番環境に影響なし
```

## サンドボックス環境の構築手順

### ステップ1：Dockerのインストール

```bash
# macOS
brew install --cask docker

# Ubuntu
sudo apt-get update
sudo apt-get install docker.io docker-compose

# Windows
# Docker Desktopをインストール
```

### ステップ2：サンドボックス用のDockerfile作成

```dockerfile
# Dockerfile
FROM ubuntu:22.04

# 基本的なツールをインストール
RUN apt-get update && apt-get install -y \
    curl \
    git \
    nodejs \
    npm \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# 作業ディレクトリ
WORKDIR /workspace

# 非rootユーザーで実行（セキュリティ向上）
RUN useradd -m -s /bin/bash developer
USER developer

# デフォルトコマンド
CMD ["/bin/bash"]
```

### ステップ3：docker-compose.ymlの作成

```yaml
# docker-compose.yml
version: '3.8'

services:
  sandbox:
    build: .
    container_name: ai-sandbox
    volumes:
      - ./workspace:/workspace  # ホストとファイル共有
    networks:
      - sandbox-network
    # リソース制限（重要！）
    deploy:
      resources:
        limits:
          cpus: '2.0'      # CPU使用量を制限
          memory: 2G       # メモリ使用量を制限
    # セキュリティ設定
    security_opt:
      - no-new-privileges:true  # 特権昇格を防止
    read_only: true  # ファイルシステムを読み取り専用に
    tmpfs:
      - /tmp  # 一時ファイル用
      - /workspace/.cache  # キャッシュ用

networks:
  sandbox-network:
    driver: bridge
```

### ステップ4：サンドボックスの起動

```bash
# サンドボックスを起動
docker-compose up -d

# サンドボックスに入る
docker-compose exec sandbox bash

# 確認
pwd  # /workspace
whoami  # developer（非rootユーザー）
```

## AIコードの安全な実行方法

### Claude Codeでサンドボックスを使用

```bash
# サンドボックス内でClaude Codeを実行
docker-compose exec sandbox bash -c "claude-code --dangerously-skip-permissions"
```

### Cursorでサンドボックスを使用

Cursorの設定：

```json
// .vscode/settings.json
{
  "terminal.integrated.defaultProfile.linux": "docker",
  "terminal.integrated.profiles.linux": {
    "docker": {
      "path": "docker",
      "args": ["exec", "-it", "ai-sandbox", "bash"]
    }
  }
}
```

これで、Cursorのターミナルが自動的にサンドボックス内で開きます。

## 高度なセキュリティ設定

### ネットワークの制限

```yaml
# docker-compose.yml
services:
  sandbox:
    # ...
    networks:
      - sandbox-network
    # 外部ネットワークへのアクセスを制限
    dns:
      - 8.8.8.8  # Google DNS（必要な場合のみ）
    # 特定のホストへのアクセスのみ許可
    extra_hosts:
      - "api.anthropic.com:104.18.0.1"  # Claude API

networks:
  sandbox-network:
    driver: bridge
    internal: true  # インターネットアクセスを完全に遮断
```

### ファイルシステムの保護

```yaml
# docker-compose.yml
services:
  sandbox:
    # ...
    read_only: true  # ルートファイルシステムを読み取り専用に
    tmpfs:
      - /tmp:size=100M,mode=1777  # 一時ファイル用（サイズ制限）
      - /workspace/.cache:size=500M  # キャッシュ用
    volumes:
      - ./workspace:/workspace:ro  # 読み取り専用でマウント
      - ./workspace/output:/workspace/output:rw  # 出力用のみ書き込み可能
```

### 権限の最小化

```dockerfile
# Dockerfile
# 非rootユーザーで実行
RUN useradd -m -s /bin/bash -u 1000 developer
USER developer

# sudoを使えないようにする
RUN rm -f /etc/sudoers.d/*
```

## サンドボックス内でのテスト実行

### AIが生成したコードをテスト

```bash
# ホストOS（本番環境）
cat > workspace/test-code.py << 'PYEOF'
# AIが生成したコード
import os
os.system("rm -rf /")  # 破壊的なコード
PYEOF

# サンドボックスで実行
docker-compose exec sandbox python3 /workspace/test-code.py

# 結果：サンドボックス内のファイルのみ影響
# ホストOSは無傷
```

### 本番環境への反映

```bash
# サンドボックスでテストが成功したら
# ホスト環境にコピー
cp workspace/output/verified-code.py production/

# または、Gitにコミット
cd workspace/output
git add verified-code.py
git commit -m "AIが生成したコード（サンドボックスでテスト済み）"
git push
```

## サンドボックスのリセット

コンテナが破壊された場合、簡単にリセットできます：

```bash
# コンテナを削除
docker-compose down

# 再作成
docker-compose up -d

# 完全にクリーンな状態に戻る
```

## 実践例：Claude CodeでTodoアプリを作成

### 安全な開発フロー

```bash
# ステップ1：サンドボックスを起動
docker-compose up -d

# ステップ2：サンドボックス内でClaude Code実行
docker-compose exec sandbox bash
cd /workspace
claude-code --dangerously-skip-permissions

# プロンプト：
# 「Node.js + Express でTodoアプリのAPIを作成してください」

# ステップ3：サンドボックス内でテスト
npm test

# ステップ4：動作確認
npm start
curl http://localhost:3000/todos

# ステップ5：問題なければホストにコピー
exit  # サンドボックスから出る
cp workspace/todo-api production/

# ステップ6：本番環境でテスト
cd production/todo-api
npm test
npm start
```

## トラブルシューティング

### Q: サンドボックス内でネットワークにアクセスできない

```yaml
# docker-compose.yml
networks:
  sandbox-network:
    internal: false  # インターネットアクセスを許可
```

### Q: ファイルの書き込みができない

```yaml
# docker-compose.yml
services:
  sandbox:
    read_only: false  # 書き込みを許可
    # または
    volumes:
      - ./workspace:/workspace:rw  # 読み書き可能
```

### Q: メモリ不足でエラーが出る

```yaml
# docker-compose.yml
services:
  sandbox:
    deploy:
      resources:
        limits:
          memory: 4G  # メモリを増やす
```

## まとめ

| 項目 | 設定 |
|-----|------|
| 基本構成 | Docker + docker-compose |
| ユーザー | 非rootユーザー（developer） |
| リソース制限 | CPU: 2コア、メモリ: 2GB |
| ファイルシステム | 読み取り専用（出力ディレクトリのみ書き込み可） |
| ネットワーク | 必要最小限（または完全遮断） |

**サンドボックス環境の利点**：
1. AIの破壊的なコードから本番環境を保護
2. 簡単にリセット可能
3. リソース制限でシステムダウンを防止
4. 権限を最小化してセキュリティ向上

次のセクションでは、エディタとツールのセキュリティ設定を学びます。
