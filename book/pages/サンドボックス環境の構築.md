# サンドボックス環境の構築

AIを安全に活用するためには、サンドボックス環境（隔離環境）が不可欠です。

## サンドボックス環境とは

**サンドボックス環境＝隔離された環境**

ローカル開発用のDocker環境のように、壊れても問題のない、本番には通信できない隔離された環境のことをサンドボックス環境といいます。

隔離された環境でAIを使用することで、本番環境に影響を与えないようにします。

### なぜサンドボックスが必要なのか

AIを使う場面には、大きく分けて2つのリスクがあります：

#### 1. AI生成コードの実行リスク

AI が生成したコードには、破壊的なコードが含まれる可能性があります：

```bash
# AIが生成した破壊的なコード例
rm -rf /  # システム全体が削除される
DROP DATABASE production;  # 本番DBが削除される
while true; do fork; done  # システムダウン
```

サンドボックス環境で実行すれば、これらのコードが実行されても本番環境には影響しません。

#### 2. 本番環境調査時のリスク

本番環境のバグを調査する際、本番データをAIに渡す必要があります。しかし、**AIツールが本番環境に直接アクセスできてしまうと、重大なセキュリティリスク**になります。

例えば：
- AIが本番DBを勝手に更新してしまう
- 個人情報がAIサービスに送信されてしまう
- 本番サーバーで破壊的なコマンドが実行されてしまう

サンドボックス環境を使うことで、これらのリスクを回避できます。

## サンドボックス環境の2つの用途

### 用途1：AIコード生成時の隔離環境

AIが生成したコードを安全にテストする環境。

```
AIコード生成
  ↓
サンドボックスでテスト
  ↓ 安全確認
本番環境に適用
```

### 用途2：本番バグ調査時の隔離環境

本番環境のデータ（ダンプ、ログ）をコピーし、AIで調査する環境。

```
本番環境
  ↓ データコピー
サンドボックス環境（本番へのアクセス不可）
  ↓
AIで調査
```

どちらの用途でも、**本番環境を保護する**ことが目的です。

## Dockerによるサンドボックス環境

### Dockerとは

- コンテナ型の仮想化技術
- ホストOSから隔離された環境
- 軽量で高速
- 簡単に作成・削除可能

### 基本的なサンドボックス構成

```
ホストOS（本番環境）
    ↓ 完全に隔離
Dockerコンテナ（サンドボックス）
    ↓ この中でAIを使用
    → 破壊されても本番環境に影響なし
```

## サンドボックス環境の構築手順

### ステップ1：Dockerのインストール

```bash
# macOS
brew install --cask docker

# Ubuntu
sudo apt-get update
sudo apt-get install docker.io docker-compose

# Windows
# Docker Desktopをインストール
```

### ステップ2：サンドボックス用のDockerfile作成

```dockerfile
# Dockerfile
FROM ubuntu:22.04

# 基本的なツールをインストール
RUN apt-get update && apt-get install -y \
    curl \
    git \
    nodejs \
    npm \
    python3 \
    python3-pip \
    mysql-client \
    && rm -rf /var/lib/apt/lists/*

# 作業ディレクトリ
WORKDIR /workspace

# 非rootユーザーで実行（セキュリティ向上）
RUN useradd -m -s /bin/bash developer
USER developer

# デフォルトコマンド
CMD ["/bin/bash"]
```

### ステップ3：docker-compose.ymlの作成

```yaml
# docker-compose.yml
version: '3.8'

services:
  sandbox:
    build: .
    container_name: ai-sandbox
    volumes:
      - ./workspace:/workspace  # ホストとファイル共有
    # リソース制限（重要！）
    deploy:
      resources:
        limits:
          cpus: '2.0'      # CPU使用量を制限
          memory: 2G       # メモリ使用量を制限
    # セキュリティ設定
    security_opt:
      - no-new-privileges:true  # 特権昇格を防止
    read_only: true  # ファイルシステムを読み取り専用に
    tmpfs:
      - /tmp  # 一時ファイル用
      - /workspace/.cache  # キャッシュ用

  # 本番バグ調査用のサンドボックスDB
  sandbox-db:
    image: mysql:8.0
    container_name: sandbox-db
    environment:
      MYSQL_ROOT_PASSWORD: sandbox-password
      MYSQL_DATABASE: sandbox
    volumes:
      - sandbox-db-data:/var/lib/mysql
    # 外部からのアクセスを遮断（sandboxコンテナからのみアクセス可）
    networks:
      - sandbox-network

networks:
  sandbox-network:
    driver: bridge
    internal: true  # インターネットアクセスを完全に遮断

volumes:
  sandbox-db-data:
```

### ステップ4：サンドボックスの起動

```bash
# サンドボックスを起動
docker-compose up -d

# サンドボックスに入る
docker-compose exec sandbox bash

# 確認
pwd  # /workspace
whoami  # developer（非rootユーザー）
```

## 本番バグ調査時のセキュリティ原則

本番環境のデータをAIで調査する際は、以下の原則を必ず守ってください。

### 原則1：本番環境で直接AIツールを使わない

- 本番環境でCursor、Claude Code等のAIツールを直接使用しない
- 本番サーバーにAIツールをインストールしない
- 必ず隔離された環境にコピーしてから使う

**理由**：
AIが本番DBを勝手に更新する、本番サーバーで破壊的なコマンドを実行するなど、予期しない動作をするリスクがあります。

### 原則2：ローカル環境でもサンドボックス環境を使う

ローカル環境にAIツールがインストールされていて、かつその環境から本番にSSH接続ができてしまう場合、**AIが本番環境にアクセスできてしまうため、これも絶対にNGです。**

**悪い例**：
```
ローカルPC（AIツールあり）
  ├─ ~/.ssh/config に本番サーバーへの接続設定
  ↓ SSH接続可能
本番サーバー
  ↓ AIが本番にアクセスできてしまう（NG）
```

**良い例**：
```
ローカルPC
  ↓
Dockerサンドボックス環境（AIツールあり）
  - 本番へのSSH設定なし
  - 本番へのネットワーク接続を遮断
  - サンドボックスDBのみ接続可
  ↓ AIは隔離環境のみアクセス（OK）
```

**正しい方法**：
1. ローカル環境上に**サンドボックス環境（Docker）を立てる**
2. サンドボックス環境の中でAIツールを使う
3. サンドボックス環境からは本番に接続できないようにする（SSH設定を分離）
4. `docker-compose.yml`の`networks: internal: true`で外部通信を遮断

### 原則3：機密情報を除外・マスキングする

**除外すべきデータ**：
- 個人情報（氏名、メールアドレス、電話番号、住所）
- 決済情報、クレジットカード情報
- 認証情報（パスワード、トークン、APIキー）

**マスキング方法**：

#### 方法1：ダミーデータに置換
```bash
# SQLダンプのメールアドレスを置換
sed -E 's/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/test@example.com/g' dump.sql > masked_dump.sql
```

#### 方法2：機密テーブルを除外
```bash
# 決済情報テーブルを除外してダンプ
mysqldump --ignore-table=database.payments --ignore-table=database.credit_cards database > dump.sql
```

#### 方法3：ログのマスキング
```bash
# ログからトークンをマスキング
sed -E 's/Bearer [A-Za-z0-9_-]+/Bearer ***/g' production.log > masked.log
```

### 原則4：本番への通信を遮断する

サンドボックス環境から本番環境への通信を完全に遮断します。

**docker-compose.ymlの設定**：
```yaml
networks:
  sandbox-network:
    driver: bridge
    internal: true  # インターネットアクセスを完全に遮断
```

**確認方法**：
```bash
# サンドボックス内から本番にアクセスできないことを確認
docker-compose exec sandbox bash
ping production-server.com  # 失敗するはず
ssh production-server  # 失敗するはず
```

### 原則5：必ず上司・セキュリティ担当に相談する

- 本番データの取り扱いは個人判断で行わない
- データのコピーや調査方法について、必ず上司の許可を取る
- 組織のセキュリティポリシーに従う
- 不明な点があれば、セキュリティ担当者に相談

## 本番バグ調査の実践例

### シナリオ：ECサイトの決済エラーを調査

#### Step 1: 本番データを取得（運用チームが実施）

```bash
# 本番DBダンプを取得
mysqldump -h production-db -u user -p database > production_dump.sql

# 本番ログをダウンロード
scp production-server:/var/log/app/* ./logs/
```

#### Step 2: 機密情報をマスキング

```bash
# メールアドレスを置換
sed -E 's/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/test@example.com/g' production_dump.sql > masked_dump.sql

# 決済情報テーブルを除外済みか確認
grep -i "INSERT INTO payments" masked_dump.sql  # 何も出力されなければOK
```

#### Step 3: サンドボックス環境に復元

```bash
# サンドボックスを起動
docker-compose up -d

# ダンプを復元
docker-compose exec -T sandbox-db mysql -u root -psandbox-password sandbox < masked_dump.sql

# ログをコピー
cp logs/* workspace/logs/
```

#### Step 4: AIで調査

```bash
# サンドボックスに入る
docker-compose exec sandbox bash

# 本番に接続できないことを確認
ping production-server.com  # 失敗
ssh production-server  # 失敗

# AIツールで調査開始
cursor .  # または claude-code
```

プロンプト例：
```
「決済エラーを調査してください。

【環境】
- DB：mysql -h sandbox-db -u root -psandbox-password sandbox
- ログ：/workspace/logs/application.log

【調査手順】
1. ログから該当時間帯のエラーを検索
2. transactionsテーブルで該当レコードを確認
3. 原因を特定

必ず証拠を提示してください。」
```

#### Step 5: 調査完了後の環境削除

```bash
# サンドボックス環境を削除
docker-compose down -v

# データも完全削除
rm -rf workspace/logs masked_dump.sql
```

## AIコード生成時の使い方

### Claude Codeでサンドボックスを使用

```bash
# サンドボックス内でClaude Codeを実行
docker-compose exec sandbox bash -c "claude-code"
```

### Cursorでサンドボックスを使用

Cursorの設定：

```json
// .vscode/settings.json
{
  "terminal.integrated.defaultProfile.linux": "docker",
  "terminal.integrated.profiles.linux": {
    "docker": {
      "path": "docker",
      "args": ["exec", "-it", "ai-sandbox", "bash"]
    }
  }
}
```

これで、Cursorのターミナルが自動的にサンドボックス内で開きます。

## サンドボックスのリセット

コンテナが破壊された場合、簡単にリセットできます：

```bash
# コンテナを削除
docker-compose down

# 再作成
docker-compose up -d

# 完全にクリーンな状態に戻る
```

## まとめ

### サンドボックス環境の重要性

| 用途 | 保護対象 | 方法 |
|-----|---------|------|
| **AIコード生成** | 本番環境 | 破壊的なコードから保護 |
| **本番バグ調査** | 本番環境・個人情報 | 本番への通信を遮断、機密情報をマスキング |

### セキュリティ原則まとめ

1. **本番環境で直接AIツールを使わない**
2. **ローカル環境でもサンドボックス環境を使う**
3. **機密情報を除外・マスキングする**
4. **本番への通信を遮断する**
5. **必ず上司・セキュリティ担当に相談する**

### サンドボックス環境の利点

1. AIの破壊的なコードから本番環境を保護
2. 本番データを安全に調査できる
3. 簡単にリセット可能
4. リソース制限でシステムダウンを防止
5. 権限を最小化してセキュリティ向上

**サンドボックス環境を正しく使うことで、AIを安全かつ効果的に活用できます。**
