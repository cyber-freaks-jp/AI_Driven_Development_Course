# サンドボックス環境の自動生成

## はじめに

Claude Codeは非常に強力なツールで、ファイルの読み書きやBashコマンドの実行が可能です。しかし、それゆえに意図しない操作で重要なファイルを削除したり、システムに影響を与える可能性があります。

そこで、安全にClaude Codeを使うために「サンドボックス環境」を用意しましょう。

## サンドボックスとは？

### 基本概念

**サンドボックス（砂場）：**
- 隔離された安全な実行環境
- 本番環境から切り離されている
- 何か問題が起きても影響が限定的
- 自由に実験できる

**身近な例：**
- 子供が砂場で遊ぶ → 家の中は汚れない
- ゲームの練習モード → 本番に影響しない
- テスト環境 → 本番環境は安全

### なぜサンドボックスが必要なのか

**危険な例：**

```bash
# Claude Codeが誤って実行する可能性
rm -rf ~/Documents/*  # ドキュメント全削除
sudo apt remove python3  # システムのPython削除
git push --force  # リモートリポジトリを破壊
```

**サンドボックスを使えば：**
- Docker内で実行されるので、ホストマシンは安全
- 問題が起きてもコンテナを削除すれば元通り
- 何度でもやり直せる

## Docker サンドボックスの仕組み

### 構成

```
┌─────────────────────────────────────┐
│      あなたのマシン（ホスト）          │
│                                     │
│  ┌──────────────────────────────┐  │
│  │   Dockerコンテナ              │  │
│  │   （サンドボックス環境）       │  │
│  │                              │  │
│  │  - Ubuntu環境                │  │
│  │  - Claude Code インストール  │  │
│  │  - 開発ツール一式            │  │
│  │                              │  │
│  │  ※ここで何が起きても、        │  │
│  │    ホストには影響なし         │  │
│  └──────────────────────────────┘  │
│                                     │
└─────────────────────────────────────┘
```

### 安全性

✓ ファイルシステムが隔離されている
✓ ネットワークも制御可能
✓ リソース制限も設定可能
✓ いつでも削除・再作成できる

## ステップ1：Dockerのインストール

### Mac の場合

1. [Docker Desktop for Mac](https://www.docker.com/products/docker-desktop/) をダウンロード
2. インストーラーを実行
3. Docker Desktopを起動

### Windows の場合

1. [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop/) をダウンロード
2. インストーラーを実行
3. WSL2のセットアップ（必要な場合）
4. Docker Desktopを起動

### Linux の場合

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER
```

### 確認

```bash
docker --version
# Docker version 24.0.0 のような出力が表示されればOK
```

## ステップ2：サンドボックス環境の作成

### Claude Code（ChatGPT）を使って作成

以下のプロンプトをClaude Code（またはChatGPT）に送信：

```
Claude Codeを安全に実行するためのDockerサンドボックス環境を作成してください。

要件：
1. ベースイメージ：Ubuntu 22.04
2. 必要なツール：
   - Node.js 20
   - Python 3.11
   - Git
   - vim, curl, wget などの基本ツール
3. 作業ディレクトリ：/workspace
4. ホストの ./workspace をマウント（データ永続化）
5. 非rootユーザー（devuser）で実行
6. Claude Code CLIをインストール

以下のファイルを作成：
- Dockerfile
- docker-compose.yml
- README.md（使い方の説明）
```

### 生成されるファイル

**Dockerfile:**
```dockerfile
FROM ubuntu:22.04

# タイムゾーン設定
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Tokyo

# 基本ツールのインストール
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    vim \
    build-essential \
    ca-certificates \
    gnupg \
    lsb-release \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Node.js 20 のインストール
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs

# Python 3.11 のインストール
RUN apt-get update && apt-get install -y \
    python3.11 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Claude Code CLI のインストール
RUN npm install -g @anthropic-ai/claude-code

# 非rootユーザーの作成
RUN useradd -m -s /bin/bash devuser && \
    echo "devuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# 作業ディレクトリ
WORKDIR /workspace

# ユーザー切り替え
USER devuser

CMD ["/bin/bash"]
```

**docker-compose.yml:**
```yaml
version: '3.8'

services:
  sandbox:
    build: .
    container_name: claude-sandbox
    volumes:
      - ./workspace:/workspace
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    stdin_open: true
    tty: true
    working_dir: /workspace
```

**.env:**
```
ANTHROPIC_API_KEY=your-api-key-here
```

**README.md:**
```markdown
# Claude Code Sandbox 環境

## セットアップ

1. APIキーを設定
   ```bash
   cp .env.example .env
   # .env ファイルにAPIキーを記入
   ```

2. コンテナをビルド
   ```bash
   docker-compose build
   ```

3. コンテナを起動
   ```bash
   docker-compose up -d
   ```

4. コンテナに接続
   ```bash
   docker-compose exec sandbox bash
   ```

## 使い方

コンテナ内で：
```bash
# Claude Codeを起動
claude-code

# プロジェクトを作成
mkdir myproject
cd myproject
claude-code
```

## 停止・削除

```bash
# 停止
docker-compose down

# 完全削除（データも削除）
docker-compose down -v
```
```

## ステップ3：環境の起動

### 1. ディレクトリ作成

```bash
mkdir claude-sandbox
cd claude-sandbox
```

### 2. ファイルを配置

上記で生成されたファイルを配置。

### 3. APIキーの設定

```bash
# .env ファイルを作成
echo "ANTHROPIC_API_KEY=your-actual-api-key" > .env
```

APIキーは [Anthropic Console](https://console.anthropic.com/) で取得。

### 4. コンテナをビルド

```bash
docker-compose build
```

所要時間：初回は3-5分

### 5. コンテナを起動

```bash
docker-compose up -d
```

### 6. コンテナに接続

```bash
docker-compose exec sandbox bash
```

**成功すると：**
```
devuser@xxxxx:/workspace$
```

このプロンプトが表示されます。

## ステップ4：Claude Code を使ってみる

### コンテナ内で実行

```bash
# Claude Code を起動
claude-code
```

### 安全なテスト

以下のようなテストをしてみましょう：

```
テスト用のNode.jsプロジェクトを作成してください。

構成：
- Express.js サーバー
- REST API（/api/users）
- 簡単なCRUD操作
- テストコード

必要なファイルを全て生成してください。
```

Claude Codeが自動的に：
1. package.json を作成
2. src/index.js を作成
3. テストファイルを作��
4. npm install を実行

**ポイント：**
- 何か問題が起きてもコンテナ内だけ
- ホストマシンは完全に安全
- いつでもコンテナを削除して再作成可能

## サンドボックスの使い方

### 基本的なワークフロー

```bash
# 1. コンテナに接続
docker-compose exec sandbox bash

# 2. プロジェクトディレクトリ作成
mkdir myproject
cd myproject

# 3. Claude Code 起動
claude-code

# 4. AIに指示
"Express.js APIサーバーを作成してください"

# 5. 動作確認
npm install
npm start

# 6. 終了
exit
```

### データの永続化

**重要：**
`/workspace` 配下に作成したファイルは、ホストマシンの `./workspace` に保存されます。

```bash
# コンテナ内
cd /workspace
mkdir myproject
# → ホストの ./workspace/myproject に保存される
```

### コンテナの再起動

```bash
# 停止
docker-compose down

# 起動
docker-compose up -d

# 接続
docker-compose exec sandbox bash
```

データは `/workspace` に保存されているので消えません。

## 高度な設定

### リソース制限

**docker-compose.yml に追加：**
```yaml
services:
  sandbox:
    # ... 既存の設定 ...
    deploy:
      resources:
        limits:
          cpus: '2.0'      # CPU 2コアまで
          memory: 4G       # メモリ 4GB まで
        reservations:
          cpus: '1.0'
          memory: 2G
```

### ネットワーク制限

特定のサイトへのアクセスのみ許可：

```yaml
services:
  sandbox:
    networks:
      - sandbox-network

networks:
  sandbox-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
```

### 複数のサンドボックス

用途別に環境を分ける：

```bash
# Python用
claude-sandbox-python/
  - Dockerfile (Python環境)
  - docker-compose.yml

# Node.js用
claude-sandbox-node/
  - Dockerfile (Node.js環境)
  - docker-compose.yml

# 機械学習用
claude-sandbox-ml/
  - Dockerfile (GPU対応)
  - docker-compose.yml
```

## トラブルシューティング

### 問題1：コンテナが起動しない

```bash
# ログを確認
docker-compose logs

# 強制的に再ビルド
docker-compose build --no-cache
docker-compose up -d
```

### 問題2：Claude Code が動かない

```bash
# コンテナ内で確認
which claude-code

# 再インストール
npm install -g @anthropic-ai/claude-code
```

### 問題3：APIキーが認識されない

```bash
# 環境変数を確認
echo $ANTHROPIC_API_KEY

# .env ファイルを確認
cat ../.env

# コンテナを再起動
docker-compose down
docker-compose up -d
```

### 問題4：ファイルが保存されない

```bash
# マウントを確認
docker-compose exec sandbox ls -la /workspace

# ホスト側を確認
ls -la ./workspace
```

## セキュリティベストプラクティス

### 1. APIキーの管理

❌ **やってはいけない：**
```yaml
environment:
  - ANTHROPIC_API_KEY=sk-ant-xxxxx  # ハードコード
```

✅ **正しい方法：**
```yaml
environment:
  - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}  # .envファイルから読み込み
```

### 2. .gitignore の設定

```.gitignore
.env
workspace/
*.log
```

### 3. 定期的なクリーンアップ

```bash
# 使っていないコンテナを削除
docker container prune

# 使っていないイメージを削除
docker image prune

# 全て削除（注意！）
docker system prune -a
```

### 4. ホストへのマウントは最小限に

```yaml
volumes:
  - ./workspace:/workspace  # 必要な部分だけ
  # - ./:/host  # ホスト全体はマウントしない
```

## 実践例：Claude Code でプロジェクト開発

### シナリオ：ToDoアプリの開発

```bash
# 1. コンテナに接続
docker-compose exec sandbox bash

# 2. プロジェクト作成
cd /workspace
mkdir todo-app
cd todo-app

# 3. Claude Code 起動
claude-code
```

**Claude Codeへの指示：**
```
React + TypeScript でToDoアプリを作成してください。

要件：
- Viteでプロジェクト作成
- タスクの追加・削除・完了
- LocalStorageで保存
- TailwindCSSでスタイリング
- TypeScript strict mode

必要なファイルを全て生成し、動作するまでセットアップしてください。
```

Claude Codeが自動的に：
1. Viteプロジェクトをセットアップ
2. 必要なパッケージをインストール
3. コンポーネントを作成
4. 動作確認
5. エラーがあれば修正

**完全に安全：**
- 何か問題が起きてもコンテナ内だけ
- 失敗してもやり直せる
- ホストマシンは影響なし

## まとめ

**サンドボックス環境の利点：**

✓ **安全性**
  - 本番環境を壊す心配がない
  - 実験が自由にできる

✓ **再現性**
  - いつでも同じ環境を作れる
  - チームで共有できる

✓ **クリーンアップ**
  - 不要になったら削除するだけ
  - ホストマシンは汚れない

✓ **学習に最適**
  - 失敗を恐れず試せる
  - 何度でもやり直せる

**次のステップ：**

1. まずシンプルなサンドボックスを作成
2. Claude Codeで小さなプロジェクトを試す
3. 慣れてきたら本格的なプロジェクトへ
4. 用途に応じてサンドボックスをカスタマイズ

Claude Codeを安全に、そして自由に使いこなしましょう！
