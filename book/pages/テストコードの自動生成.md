# テストコードの自動生成

## はじめに

サンドボックス環境を構築したので、いよいよClaude Codeで完全自動実行を試してみましょう。このセクションでは、実践例として「オセロゲームのテストコード」を自動生成します。

## なぜテストコード生成なのか

テストコード生成は、完全自動実行の練習に最適です：

**理由：**
1. **安全性が高い**
   - テストコードは既存コードを壊さない
   - 実行してもアプリに影響しない

2. **結果が明確**
   - テストが通るか通らないか
   - 成功・失敗が一目瞭然

3. **実用性が高い**
   - テストコード作成は時間がかかる
   - 自動化の恩恵が大きい

4. **学習に最適**
   - Claude Codeの動きを観察できる
   - エラー修正の過程を学べる

## 準備：サンドボックス環境を起動

### ステップ1：サンドボックスに接続

```bash
# コンテナを起動
docker-compose up -d

# コンテナに接続
docker-compose exec sandbox bash
```

### ステップ2：プロジェクトディレクトリ作成

```bash
cd /workspace
mkdir othello-game
cd othello-game
```

## オセロゲームの実装（前提）

Cursorで作成したオセロゲーム（「オセロゲームをAIで作ってみよう」の章）をサンドボックス環境にコピーします。

または、以下のコマンドで簡易版を作成：

```bash
# TypeScript環境のセットアップ
npm init -y
npm install --save-dev jest @types/jest ts-jest typescript @types/node
npx ts-jest config:init
```

**src/othello.ts（簡易実装）を配置します。**

## Claude Codeでテストコード生成

### ルールファイルの作成

```bash
mkdir .claude
cat > .claude/instructions.md << 'EOF'
# オセロゲーム テスト生成プロジェクト

## 自動実行の許可
このプロジェクトでは完全自動実行を許可します。

## 許可される操作
✓ プロジェクト内のファイル読み書き
✓ npm/yarn コマンド
✓ テスト実行（npm test）
✓ TypeScriptのコンパイル

## 禁止される操作
✗ プロジェクト外のファイル操作
✗ git操作
✗ システムコマンド

## 技術スタック
- TypeScript
- Jest
- ts-jest

## テストの方針
- すべての public メソッドをテスト
- エッジケースも含める
- テストカバレッジ90%以上を目指す
- 各テストは独立して実行可能
- わかりやすいテスト名

## ワークフロー
1. 既存のsrc/othello.tsを読んで理解
2. 包括的なテストコードを作成
3. npm test を実行
4. エラーがあれば修正
5. 全テスト通過まで繰り返し
EOF
```

### Claude Code を起動

```bash
# 完全自動モードで起動
claude-code --dangerously-skip-permissions
```

### プロンプト

Claude Codeに以下を指示：

```
src/othello.ts のための包括的なテストコードを作成してください。

要件：
1. src/__tests__/othello.test.ts に作成
2. 以下をテスト：
   - ボードの初期化
   - コマの配置
   - コマの裏返し
   - 有効な手の判定
   - プレイヤーの切り替え
   - スコア計算
   - エッジケース（境界、無効な操作など）

3. テストカバレッジ90%以上
4. npm test で全テスト通過を確認
5. エラーがあれば自動的に修正

完了まで自動で実行してください。
```

## Claude Codeの実行過程

### Phase 1: ファイルの理解

```
✓ Reading src/othello.ts
✓ Analyzing OthelloGame class
✓ Identifying all public methods
✓ Understanding game logic
```

### Phase 2: テストコード生成

```
✓ Creating src/__tests__/othello.test.ts
✓ Writing test cases:
  - Board initialization tests
  - Move validation tests
  - Piece flipping tests
  - Player switching tests
  - Score calculation tests
  - Edge case tests
```

### Phase 3: テスト実行

```
✓ Running npm test
✓ Test Results:
  PASS  src/__tests__/othello.test.ts
    ✓ should initialize board correctly (5ms)
    ✓ should place black piece at valid position (3ms)
    ✓ should flip white pieces correctly (4ms)
    ...

  Test Suites: 1 passed, 1 total
  Tests:       25 passed, 25 total
  Coverage:    93.5%
```

### Phase 4: カバレッジ改善（必要な場合）

もしカバレッジが足りなければ：

```
✓ Analyzing uncovered lines
✓ Adding additional test cases
✓ Re-running tests
✓ Coverage now: 95.2%
```

## 実行結果の確認

### テスト実行

```bash
npm test
```

**出力例：**
```
 PASS  src/__tests__/othello.test.ts
  OthelloGame
    Initialization
      ✓ should initialize 8x8 board (3ms)
      ✓ should place initial pieces correctly (2ms)
      ✓ should start with black player (1ms)
    Valid Moves
      ✓ should allow valid black moves initially (3ms)
      ✓ should return false for invalid move (1ms)
    Piece Flipping
      ✓ should flip opponent pieces after valid move (2ms)
    Player Switching
      ✓ should switch to white after black move (2ms)
    Score Calculation
      ✓ should count initial pieces correctly (2ms)

Test Suites: 1 passed, 1 total
Tests:       25 passed, 25 total
Coverage:    95.2%
```

## 完全自動実行の利点

### 時間の節約

**手動の場合：**
```
1. テストケースを考える（30分）
2. テストコードを書く（1時間）
3. エラー修正（30分）
4. カバレッジ確認と追加（30分）

合計：約2.5時間
```

**Claude Codeの場合：**
```
1. プロンプトを書く（5分）
2. 実行（自動）（5分）

合計：約10分
```

### 品質の向上

✓ **網羅的なテスト**
  - 人間が見落としがちなエッジケースもカバー
  - 境界値テストも自動生成

✓ **一貫性**
  - 同じスタイルでテストコードが生成される
  - 命名規則も統一

✓ **最新のベストプラクティス**
  - Jestの最新機能を活用
  - 適切なアサーション

## まとめ

**学んだこと：**

✓ Claude Codeで完全自動実行
✓ テストコードの自動生成
✓ サンドボックスでの安全な実行
✓ ルールファイルでの制御

**完全自動実行の威力：**

1. **時間削減**
   - 手動作業の1/10以下の時間
   - 開発に集中できる

2. **品質向上**
   - 網羅的なテスト
   - エッジケースもカバー

3. **一貫性**
   - 統一されたスタイル
   - ベストプラクティス

Claude Codeを使えば、テストコード作成の時間を大幅に削減できます！
